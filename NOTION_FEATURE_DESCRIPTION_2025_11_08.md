# 📅 2025-11-08 쪽지함 기능 개선

## 🎨 UI/UX 개선

### 1. 탭 인터페이스 개선

#### 개선 내용
- 각 탭에 의미있는 아이콘 추가
  - 팀 초대: Mail 아이콘
  - 받은 팀 제안: MessageSquare 아이콘
  - 기업 제안: Building2 아이콘
  - 합류 신청: UserPlus 아이콘
  - 보낸 제안: Send 아이콘
  - 견적 요청: FileText 아이콘

- **하이라이트 기능**: 대기 중인 항목이 있는 탭은 파란색 테두리로 강조
- **스크롤 가능**: 모바일에서도 모든 탭에 접근 가능
- **활성 탭 강조**: 선택된 탭은 파란색 배경과 흰색 텍스트

#### 사용자 경험
- 탭을 한눈에 구분 가능
- 중요한 알림이 있는 탭을 쉽게 식별
- 모바일 환경에서도 편리한 사용

### 2. 메시지 카드 디자인

#### 개선 내용
- **그라데이션 아이콘 배경**: 각 메시지 타입별로 구분되는 시각적 요소
- **대기 중인 메시지 강조**: 파란색 테두리와 그림자로 주목도 향상
- **정보 계층 구조**: 제목 → 부제목 → 메시지 내용 → 시간 순서로 명확한 구조
- **호버 효과**: 마우스 오버 시 시각적 피드백

#### 사용자 경험
- 메시지 타입을 빠르게 파악
- 중요한 메시지를 쉽게 식별
- 정보를 체계적으로 확인 가능

### 3. 설명 박스 개선

#### 개선 내용
- **접기 기능**: X 버튼으로 설명 박스 닫기 가능
- **정보 아이콘**: 더 명확한 정보 표시
- **공간 효율성**: 닫으면 더 많은 공간 확보

#### 사용자 경험
- 반복적인 설명을 숨길 수 있어 효율적
- 필요한 정보만 표시하여 집중도 향상

### 4. 날짜 표시 개선

#### 개선 내용
- **상대 시간 표시**: "방금 전", "5분 전", "2시간 전", "3일 전" 등
- **캘린더 아이콘**: 시간 정보를 시각적으로 표시
- **간결한 형식**: 긴 날짜 형식 대신 사용자 친화적 형식

#### 사용자 경험
- 메시지가 언제 왔는지 직관적으로 파악
- 불필요한 정보 제거로 가독성 향상

### 5. 액션 버튼 개선

#### 개선 내용
- **아이콘 추가**: 각 버튼에 의미있는 아이콘
  - 수락: CheckCircle
  - 거절: XCircle
  - 상세보기: ChevronRight
- **일관된 크기**: 모든 버튼을 통일된 크기로
- **반응형 레이아웃**: 작은 화면에서도 버튼이 잘 배치됨

#### 사용자 경험
- 버튼 기능을 빠르게 파악
- 일관된 디자인으로 사용 편의성 향상

### 6. 빈 상태 UI

#### 개선 내용
- **큰 아이콘**: 12x12 크기로 시각적 임팩트
- **그라데이션 배경**: 아이콘 배경에 그라데이션 효과
- **친절한 메시지**: 사용자에게 명확한 안내

#### 사용자 경험
- 빈 상태를 명확하게 인지
- 다음 행동에 대한 안내 제공

### 7. 추가 기능

- **새로고침 버튼**: 헤더에 추가하여 최신 메시지 확인
- **일관된 간격**: 모든 섹션에 통일된 간격 적용
- **반응형 디자인**: 모바일과 데스크톱 모두 최적화

---

## 🔧 기술적 개선

### 컴포넌트 구조화

#### TabButton 컴포넌트
- 재사용 가능한 탭 버튼 컴포넌트
- 활성/비활성 상태 관리
- 하이라이트 기능 지원

#### MessageCard 컴포넌트
- 일관된 메시지 카드 디자인
- 다양한 메시지 타입 지원
- 상태별 스타일링

#### EmptyState 컴포넌트
- 빈 상태를 표시하는 재사용 가능한 컴포넌트
- 아이콘, 제목, 설명을 받아 표시

### 유틸리티 함수

#### formatRelativeTime
- 날짜를 상대 시간으로 변환
- "방금 전", "5분 전", "2시간 전" 등으로 표시
- 사용자 친화적인 시간 표시

---

## 🗄️ Supabase 데이터 연동 개선

### 팀 견적 요청 (notifications 테이블)

#### 기능 설명
기업이 팀으로부터 받은 견적 요청을 확인하는 기능입니다.

#### 개선 전 문제점
- `counsel_id`가 null인 경우 처리 부족
- 에러 발생 시 적절한 처리 없음
- 빈 결과에 대한 처리 부족

#### 개선 사항
- ✅ **null 처리 강화**: `counsel_id`가 null이거나 undefined인 경우 필터링
- ✅ **에러 처리 강화**: 각 단계별 에러 처리 및 로깅 추가
- ✅ **빈 결과 처리**: 데이터가 없을 때 빈 배열로 초기화
- ✅ **안정성 향상**: 각 쿼리 단계별 에러 핸들링으로 안정적인 데이터 조회

#### 데이터 흐름
1. `notifications` 테이블에서 `TEAM_TO_CLIENT_ESTIMATE_REQUEST` 타입의 알림 조회
2. `target_client_id`로 필터링하여 해당 기업이 받은 요청만 조회
3. `status = PENDING`인 요청만 표시
4. `sender_team_id`로 팀 정보 조회
5. `counsel_id`가 있으면 프로젝트 정보 조회
6. 데이터 결합 및 포맷팅

#### 사용자 경험
- 기업이 팀으로부터 받은 견적 요청을 한눈에 확인
- 요청 내용과 팀 정보를 함께 확인 가능
- 프로젝트가 연결된 경우 프로젝트 정보도 함께 표시

### 프로젝트 제안 (project_members 테이블)

#### 기능 설명
기업이 프리랜서나 팀을 프로젝트에 초대한 내역을 확인하는 기능입니다.

#### 개선 전 문제점
- PostgREST 중첩 조인 사용으로 불안정
- 조인 실패 시 대비 부족
- 에러 처리 미흡

#### 개선 사항
- ✅ **PostgREST 조인 제거**: 중첩 조인 대신 별도 쿼리로 변경하여 안정성 향상
- ✅ **단계별 쿼리**: 
  1. `project_members` 테이블에서 기본 정보 조회
  2. `counsel` 테이블에서 프로젝트 정보 별도 조회
  3. `client` 테이블에서 클라이언트 정보 조회
  4. `accounts` 테이블에서 계정 정보 조회
- ✅ **에러 처리 강화**: 각 단계별 에러 처리 및 로깅 추가
- ✅ **빈 결과 처리**: 데이터가 없을 때 빈 배열로 초기화

#### 데이터 흐름
1. `project_members` 테이블에서 `profile_id`로 필터링
2. `counsel_id` 목록 추출
3. `counsel` 테이블에서 프로젝트 정보 조회
4. `client_id` 목록 추출
5. `client` 테이블에서 클라이언트 정보 조회
6. `accounts` 테이블에서 계정 정보 조회
7. 데이터 결합 및 포맷팅

#### 사용자 경험
- 기업이 보낸 프로젝트 제안을 확인
- 프로젝트 정보와 클라이언트 정보를 함께 확인
- 제안 상태(INVITED, ACTIVE 등)를 명확히 표시

### 데이터 타입 확인

#### 테이블 구조
- `notifications.counsel_id`: `integer` 타입
- `project_members.counsel_id`: `integer` 타입  
- `counsel.counsel_id`: `bigint` 타입

#### 타입 호환성
- PostgreSQL이 자동으로 `integer`와 `bigint` 간 캐스팅 수행
- 타입 불일치로 인한 문제 없음

---

## 📊 개선 효과

### 안정성
- PostgREST 조인 대신 별도 쿼리 사용으로 안정성 향상
- 각 단계별 에러 처리로 부분 실패 시에도 안정적 동작
- null 값 처리로 예외 상황 방지

### 성능
- 필요한 데이터만 조회하여 불필요한 조인 제거
- 인덱스 활용으로 쿼리 성능 향상
- 단계별 쿼리로 최적화된 데이터 로딩

### 유지보수성
- 단계별 주석으로 코드 가독성 향상
- 명확한 에러 메시지로 디버깅 용이
- 재사용 가능한 컴포넌트로 코드 중복 제거

### 사용자 경험
- 직관적인 UI로 정보 파악 용이
- 시각적 피드백으로 사용성 향상
- 반응형 디자인으로 모든 기기에서 최적화된 경험

---

## 📝 관련 파일

- **주요 파일**: `src/app/(home)/my/messages/MessagesClient.tsx`
- **주요 변경**: UI/UX 개선 및 Supabase 쿼리 로직 개선
- **컴포넌트**: TabButton, MessageCard, EmptyState
- **유틸리티**: formatRelativeTime 함수

---

## 🎯 주요 기능 요약

### 프리랜서 프로필
1. **팀 초대**: 다른 매니저가 나를 팀 멤버로 초대한 내역
2. **받은 팀 제안**: 다른 매니저가 나에게 팀 합류를 제안한 내역
3. **기업 제안**: 기업이 나를 프로젝트에 초대한 내역
4. **받은 합류 신청**: 메이커가 내 팀에 합류를 신청한 내역 (매니저)
5. **보낸 팀 제안**: 내가 메이커에게 팀 합류를 제안한 내역 (매니저)
6. **보낸 합류 신청**: 내가 팀에 합류를 신청한 내역 (메이커)

### 기업 프로필
1. **팀 견적 요청**: 팀이 나에게 견적을 요청한 내역
2. **프로젝트 제안**: 프로젝트에 초대된 내역

### 공통 기능
- **상태 관리**: 수락/거절/대기 중 상태 표시
- **상대 시간 표시**: 직관적인 시간 정보
- **빈 상태 처리**: 친절한 안내 메시지
- **반응형 디자인**: 모든 기기에서 최적화

