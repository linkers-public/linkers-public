# 구독 관리 / 결제 내역 / 연락처 열람 기록 페이지 검토

## 📋 검토 대상

1. **구독 관리** (`/my/subscription`)
2. **결제 내역** (`/my/payments`)
3. **연락처 열람 기록** (`/my/contact-history`)

**참고**: 
- "연락처 열람 기록"은 프리랜서 연락처 구매 기록을 의미합니다.
- "견적서 열람 기록"은 견적서 상세 내역 열람 기록을 의미합니다.
- 견적서 열람 기록 페이지는 `/my/estimate-view-history`로 추가되었습니다.

**무료 열람 정책**:
- 신규 회원가입 시 구독을 하지 않아도 기본 3회 무료 열람 제공
- 구독과 무료 열람은 별개 기능
- 구독 가입/해지와 무관하게 무료 열람 횟수 유지
- **무료 열람으로 견적서를 열람하면, 견적서에 포함된 연락처 정보도 함께 확인 가능**

---

## 1. 구독 관리 (`/my/subscription`)

### ✅ 구현된 기능

1. **구독 정보 조회**
   - `subscriptions` 테이블에서 구독 정보 조회
   - 구독 상태, 플랜, 가격, 다음 결제일 표시
   - 자동 갱신 설정 표시

2. **자동 갱신 토글**
   - `handleRenewalToggle()`: 자동 갱신 활성화/해제
   - `subscriptions.auto_renew` 업데이트

3. **구독 해지**
   - `handleCancel()`: 구독 해지 기능
   - `/api/subscription-v2/cancel` API 호출

4. **결제 재시도**
   - `handleRetryPayment()`: 실패한 결제 재시도
   - `/api/subscription-v2/retry-payment` API 호출

5. **최근 결제 내역**
   - 최근 5개 결제 내역 표시
   - 영수증 다운로드 버튼

6. **구독 등록**
   - 구독이 없을 때 "구독 등록하기" 버튼
   - `/my/subscription/register-v2`로 이동

### ⚠️ 문제점

1. **가격 정보 불일치**
   - 코드 234줄: "월 2,000원 상태 / 갱신 / 해지" (하드코딩)
   - 실제 구독 가격: `subscription.price` (데이터베이스에서 가져옴)
   - 사용자 요구사항: 월구독 1만원
   - **수정 필요**: 하드코딩된 가격을 제거하고 실제 가격 표시

2. **무료 열람과 구독의 관계**
   - **중요**: 무료 열람은 구독과 **별개**입니다
   - 신규 회원가입 시 구독을 하지 않아도 기본 3회 무료 열람 제공
   - 구독 가입 여부와 관계없이 모든 신규 기업 계정에 3회 무료 열람 제공
   - 구독은 무제한 열람을 위한 별도 서비스
   - 무료 열람 횟수는 구독 가입/해지와 무관하게 유지됨

3. **구독 등록 페이지**
   - `/my/subscription/register-v2`로 이동
   - 구독 가격이 1만원인지 확인 필요

### 📝 개선 사항

1. **가격 표시 수정**
   ```tsx
   // 현재 (234줄)
   <p className="text-gray-600">월 2,000원 상태 / 갱신 / 해지</p>
   
   // 수정 후
   <p className="text-gray-600">구독 상태 관리 및 결제 내역 확인</p>
   // 또는 실제 가격을 동적으로 표시
   ```

2. **구독 가격 확인**
   - 구독 등록 시 가격이 1만원인지 확인
   - 구독 관리 페이지에서 실제 가격 표시

---

## 2. 결제 내역 (`/my/payments`)

### ✅ 구현된 기능

1. **결제 내역 조회**
   - `payments` 테이블에서 결제 내역 조회
   - 최근 50개 결제 내역 표시
   - 결제 금액, 날짜, 상태 표시

2. **영수증 다운로드**
   - `handleDownloadReceipt()`: 영수증 조회
   - `/api/payments/receipt` API 호출
   - PortOne 관리자 콘솔에서 영수증 확인

3. **결제 상태 표시**
   - 완료/대기중/실패 상태 표시
   - 상태별 색상 구분

4. **결제 정보 표시**
   - 결제 금액, 날짜, 결제 수단
   - 주문번호 (merchant_uid)
   - 첫 달 무료 표시

### ⚠️ 문제점

1. **견적서 열람 결제 구분**
   - 현재는 모든 결제 내역을 표시
   - 구독 결제와 견적서 열람 결제를 구분하지 않음
   - **개선 필요**: 결제 타입별 필터링 또는 구분 표시

2. **결제 타입 표시**
   - `payments` 테이블에 결제 타입 컬럼 확인 필요
   - 구독 결제 vs 견적서 열람 결제 구분

3. **영수증 기능**
   - PortOne 관리자 콘솔로 이동하는 방식
   - 실제 영수증 PDF 다운로드 기능은 없음

### 📝 개선 사항

1. **결제 타입 필터 추가**
   ```tsx
   // 결제 타입 필터
   const [paymentTypeFilter, setPaymentTypeFilter] = useState<'all' | 'subscription' | 'estimate_view'>('all')
   
   // 필터링 로직
   const filteredPayments = payments.filter(payment => {
     if (paymentTypeFilter === 'all') return true
     if (paymentTypeFilter === 'subscription') return payment.subscription_id !== null
     if (paymentTypeFilter === 'estimate_view') return payment.type === 'estimate_view'
   })
   ```

2. **결제 타입 표시**
   - 각 결제 내역에 결제 타입 표시
   - "구독 결제" / "견적서 열람" 구분

---

## 3. 연락처 열람 기록 (`/my/contact-history`)

### ✅ 구현된 기능

1. **연락처 열람 기록 조회**
   - `contact_purchases` 테이블에서 구매 기록 조회
   - 프리랜서 연락처 구매 기록 표시

2. **프리랜서 정보 표시**
   - 구매한 프리랜서의 username 표시
   - 프로필 보기 링크

3. **구매 정보 표시**
   - 구매일, 구매 금액 표시

### ⚠️ 문제점

1. **연락처 정보 미표시**
   - 코드 96줄: `contact_phone: ''` (빈 문자열)
   - `accounts` 테이블에 `contact_phone` 컬럼이 없음
   - **문제**: 연락처를 구매했는데 연락처 정보가 표시되지 않음

2. **페이지 목적 불명확**
   - 사용자가 "연락처 열람 기록"이라고 했지만
   - 실제로는 "견적서 열람 기록"을 원할 수도 있음
   - **확인 필요**: 어떤 기능인지 명확히 해야 함

3. **견적서 열람 기록 페이지 없음**
   - 견적서 열람 MVP가 구현되었지만
   - 견적서 열람 기록을 조회하는 페이지가 없음
   - `getEstimateViewHistory()` API는 있지만 UI가 없음

### 📝 개선 사항

1. **견적서 열람 기록 페이지 추가**
   - `/my/estimate-view-history` 페이지 생성
   - `getEstimateViewHistory()` API 사용
   - 견적서 열람 기록 표시 (무료/구독/건별 결제 구분)

2. **연락처 정보 표시**
   - `contact_purchases` 테이블에 연락처 정보가 저장되어 있는지 확인
   - 연락처 정보 표시 로직 추가

---

## 🔍 종합 검토

### 공통 문제점

1. **가격 정보 불일치**
   - 구독 관리 페이지: "월 2,000원" 하드코딩
   - 실제 요구사항: 월구독 1만원
   - **수정 필요**: 하드코딩 제거, 실제 가격 표시

2. **결제 타입 구분 부족**
   - 결제 내역 페이지에서 구독 결제와 견적서 열람 결제 구분 없음
   - **개선 필요**: 결제 타입별 필터링 및 표시

3. **견적서 열람 기록 페이지 없음**
   - 견적서 열람 MVP는 구현되었지만
   - 열람 기록을 조회하는 페이지가 없음
   - **추가 필요**: `/my/estimate-view-history` 페이지

### 우선순위별 개선 사항

#### 우선순위 1: 즉시 수정 필요

1. **구독 관리 페이지 가격 수정**
   - 하드코딩된 "월 2,000원" 제거
   - 실제 구독 가격 표시 (1만원 확인)

2. **견적서 열람 기록 페이지 추가**
   - `/my/estimate-view-history` 페이지 생성
   - `getEstimateViewHistory()` API 사용
   - 열람 타입별 구분 표시 (무료/구독/건별 결제)

#### 우선순위 2: UX 개선

1. **결제 내역 페이지 필터 추가**
   - 결제 타입별 필터 (전체/구독/견적서 열람)
   - 각 결제 내역에 결제 타입 표시

2. **연락처 열람 기록 페이지 개선**
   - 연락처 정보 표시 로직 추가
   - 또는 페이지 목적 명확화

#### 우선순위 3: 기능 보완

1. **영수증 기능 개선**
   - 실제 영수증 PDF 다운로드 기능
   - 또는 영수증 정보 상세 표시

2. **구독 가격 확인**
   - 구독 등록 시 가격이 1만원인지 확인
   - 구독 관리 페이지에서 실제 가격 표시

---

## 📊 현재 상태 요약

| 페이지 | 구현 상태 | 주요 문제 | 우선순위 |
|--------|----------|----------|----------|
| 구독 관리 | ✅ 구현됨 | 가격 하드코딩 (2,000원) | 높음 |
| 결제 내역 | ✅ 구현됨 | 결제 타입 구분 없음 | 중간 |
| 연락처 열람 기록 | ✅ 구현됨 | 연락처 정보 미표시, 목적 불명확 | 중간 |
| 견적서 열람 기록 | ❌ 없음 | 페이지 자체가 없음 | 높음 |

---

## 🚀 다음 단계

1. **구독 관리 페이지 가격 수정** (즉시)
2. **견적서 열람 기록 페이지 추가** (즉시)
3. **결제 내역 페이지 필터 추가** (다음)
4. **연락처 열람 기록 페이지 개선** (다음)

