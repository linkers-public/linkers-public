"""
ë²•ë¥ /ê³„ì•½ì„œ RAG ì „ìš© í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
"""

import logging
from typing import Optional

logger = logging.getLogger(__name__)

# ============================================================================
# ë²•ë¥  ìƒë‹´ ì±— í”„ë¡¬í”„íŠ¸
# ============================================================================

LEGAL_CHAT_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ í•œêµ­ ë…¸ë™ë²•/ê³„ì•½ ì‹¤ë¬´ì— íŠ¹í™”ëœ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

**ì¤‘ìš”: ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ì–´ë¡œ ë‹µë³€í•˜ì§€ ë§ˆì„¸ìš”.**

**ì¤‘ìš”í•œ ì›ì¹™:**
1. ì´ ì„œë¹„ìŠ¤ëŠ” ë²•ë¥  ìë¬¸ì´ ì•„ë‹™ë‹ˆë‹¤. ì •ë³´ ì•ˆë‚´ì™€ ê°€ì´ë“œë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
2. í•­ìƒ ê´€ë ¨ ë²•ë ¹/ê°€ì´ë“œë¥¼ ê·¼ê±°ë¡œ ì„¤ëª…í•˜ì„¸ìš”.
3. ë‹µë³€ì€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš” (ì œëª©, ë¦¬ìŠ¤íŠ¸, ê°•ì¡° ë“±).
4. ë‹µë³€ ë§ˆì§€ë§‰ì— "ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥" ë¬¸êµ¬ë¥¼ í¬í•¨í•˜ì„¸ìš”.
5. ëª¨ë“  ë‹µë³€ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”. ì˜ì–´, ì¤‘êµ­ì–´, ì¼ë³¸ì–´ ë“± ë‹¤ë¥¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.

**ë‹µë³€ êµ¬ì¡°:**
1. ìš”ì•½ ê²°ë¡  (í•œ ë¬¸ì¥, í•œêµ­ì–´)
2. ì™œ ìœ„í—˜í•œì§€ (ë²•ì  ë¦¬ìŠ¤í¬, í•œêµ­ì–´)
3. ì‹¤ë¬´ í˜‘ìƒ í¬ì¸íŠ¸ (í˜„ì‹¤ì ì¸ ì˜µì…˜, í•œêµ­ì–´)
4. ì°¸ê³  ë²•ë ¹/í‘œì¤€ ê³„ì•½ ìš”ì•½ (í•œêµ­ì–´)
"""


def build_legal_chat_prompt(
    query: str,
    contract_chunks: list = None,
    legal_chunks: list = None,
    selected_issue: dict = None,
    analysis_summary: str = None,
    risk_score: int = None,
    total_issues: int = None,
) -> str:
    """
    ë²•ë¥  ìƒë‹´ ì±—ìš© í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    
    Args:
        query: ì‚¬ìš©ì ì§ˆë¬¸
        contract_chunks: ê³„ì•½ì„œ ë‚´ë¶€ ì²­í¬
        legal_chunks: ë²•ë ¹ ì²­í¬
        selected_issue: ì„ íƒëœ ì´ìŠˆ ì •ë³´
        analysis_summary: ë¶„ì„ ìš”ì•½
        risk_score: ìœ„í—˜ë„ ì ìˆ˜
        total_issues: ì „ì²´ ì´ìŠˆ ê°œìˆ˜
    
    Returns:
        ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´
    """
    # ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
    context_parts = []
    
    # ê³„ì•½ì„œ ì²­í¬ ì¶”ê°€
    if contract_chunks:
        context_parts.append("=== ê³„ì•½ì„œ ë‚´ìš© ===")
        for chunk in contract_chunks[:3]:  # ìƒìœ„ 3ê°œë§Œ ì‚¬ìš©
            article_num = chunk.get("article_number", "")
            content = chunk.get("content", "")[:500]  # 500ìë¡œ ì œí•œ
            context_parts.append(f"ì œ{article_num}ì¡°:\n{content}")
    
    # ë²•ë ¹ ì²­í¬ ì¶”ê°€
    if legal_chunks:
        context_parts.append("\n=== ê´€ë ¨ ë²•ë ¹/ê°€ì´ë“œë¼ì¸ ===")
        for chunk in legal_chunks[:5]:  # ìƒìœ„ 5ê°œë§Œ ì‚¬ìš©
            # LegalGroundingChunkëŠ” Pydantic ëª¨ë¸ì´ë¯€ë¡œ getattr ì‚¬ìš©
            source_type = getattr(chunk, 'source_type', 'law')
            title = getattr(chunk, 'title', '')
            snippet = getattr(chunk, 'snippet', getattr(chunk, 'content', ''))[:500]
            context_parts.append(f"[{source_type}] {title}\n{snippet}")
    
    context = "\n\n".join(context_parts)
    
    # ì„ íƒëœ ì´ìŠˆ ì •ë³´ ì¶”ê°€
    issue_context = ""
    if selected_issue:
        issue_context = f"""
**ì„ íƒëœ ìœ„í—˜ ì¡°í•­ ì •ë³´:**
- ì¹´í…Œê³ ë¦¬: {selected_issue.get('category', 'ì•Œ ìˆ˜ ì—†ìŒ')}
- ìš”ì•½: {selected_issue.get('summary', '')}
- ìœ„í—˜ë„: {selected_issue.get('severity', 'medium')}
- ì¡°í•­ ë‚´ìš©: {selected_issue.get('originalText', '')[:500]}
- ê´€ë ¨ ë²•ë ¹: {', '.join(selected_issue.get('legalBasis', [])[:3])}
"""
    
    # ë¶„ì„ ìš”ì•½ ì¶”ê°€
    analysis_context = ""
    if analysis_summary:
        analysis_context = f"\n**ì „ì²´ ë¶„ì„ ìš”ì•½:** {analysis_summary}"
    if risk_score is not None:
        analysis_context += f"\n**ì „ì²´ ìœ„í—˜ë„:** {risk_score}ì "
    if total_issues is not None:
        analysis_context += f"\n**ë°œê²¬ëœ ìœ„í—˜ ì¡°í•­ ìˆ˜:** {total_issues}ê°œ"
    
    prompt = f"""{LEGAL_CHAT_SYSTEM_PROMPT}

**ì‚¬ìš©ì ì§ˆë¬¸:**
{query}
{issue_context}
{analysis_context}

**ê´€ë ¨ ë²•ë ¹/ê°€ì´ë“œ/ì¼€ì´ìŠ¤:**
{context}

**âš ï¸ ì¤‘ìš”í•œ ì–¸ì–´ ê·œì¹™:**
- ëª¨ë“  ë‹µë³€ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
- ì˜ì–´, ì¤‘êµ­ì–´, ì¼ë³¸ì–´ ë“± ë‹¤ë¥¸ ì–¸ì–´ë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
- ëª¨ë“  í…ìŠ¤íŠ¸(ì œëª©, ë³¸ë¬¸, ì„¤ëª… ë“±)ëŠ” í•œêµ­ì–´ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ë‹¤ìŒ êµ¬ì¡°ë¡œ **í•œêµ­ì–´ë¡œë§Œ** ë‹µë³€í•´ì£¼ì„¸ìš”:

## ìš”ì•½ ê²°ë¡ 
[í•œ ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ë‹µë³€ (í•œêµ­ì–´)]

## ì™œ ìœ„í—˜í•œì§€ (ë²•ì  ë¦¬ìŠ¤í¬)
[ê´€ë ¨ ë²•ë ¹ì„ ê·¼ê±°ë¡œ ìœ„í—˜ì„± ì„¤ëª… (í•œêµ­ì–´)]

## ì‹¤ë¬´ í˜‘ìƒ í¬ì¸íŠ¸
[í˜„ì‹¤ì ì¸ í˜‘ìƒ ì˜µì…˜ê³¼ ëŒ€ì•ˆ ì œì‹œ (í•œêµ­ì–´)]

## ì°¸ê³  ë²•ë ¹/í‘œì¤€ ê³„ì•½
[ê´€ë ¨ ë²•ë ¹ ìš”ì•½ ë° ì¶œì²˜ (í•œêµ­ì–´)]

---
**âš ï¸ ì°¸ê³ :** ì´ ë‹µë³€ì€ ì •ë³´ ì•ˆë‚´ë¥¼ ìœ„í•œ ê²ƒì´ë©° ë²•ë¥  ìë¬¸ì´ ì•„ë‹™ë‹ˆë‹¤. ì¤‘ìš”í•œ ì‚¬ì•ˆì€ ì „ë¬¸ ë³€í˜¸ì‚¬ë‚˜ ë…¸ë™ìœ„ì›íšŒ ë“± ì „ë¬¸ ê¸°ê´€ì— ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
"""
    
    return prompt


# ============================================================================
# ê³„ì•½ì„œ ë¶„ì„ í”„ë¡¬í”„íŠ¸
# ============================================================================

CONTRACT_ANALYSIS_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ í•œêµ­ ë…¸ë™ë²• ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê³„ì•½ì„œë¥¼ ë¶„ì„í•˜ì—¬ ìœ„í—˜ ì¡°í•­ì„ ì‹ë³„í•˜ê³  ê°œì„ ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.

**ì¤‘ìš”: ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.**

**ë¶„ì„ ì›ì¹™:**
1. ê·¼ë¡œê¸°ì¤€ë²•, ìµœì €ì„ê¸ˆë²• ë“± ê´€ë ¨ ë²•ë ¹ì„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„
2. í‘œì¤€ê·¼ë¡œê³„ì•½ì„œì™€ ë¹„êµí•˜ì—¬ ëˆ„ë½/ê³¼ë„í•œ ì¡°í•­ ì‹ë³„
3. ê° ìœ„í—˜ ì¡°í•­ì— ëŒ€í•´ êµ¬ì²´ì ì¸ ë²•ì  ê·¼ê±° ì œì‹œ
4. ì‹¤ë¬´ì ì¸ ê°œì„ ì•ˆê³¼ í˜‘ìƒ í¬ì¸íŠ¸ ì œì‹œ
5. ëª¨ë“  í…ìŠ¤íŠ¸ ì‘ë‹µ(summary, description, rationale ë“±)ì€ í•œêµ­ì–´ë¡œ ì‘ì„±
"""


def build_contract_analysis_prompt(
    contract_text: str,
    clauses: list = None,
    grounding_chunks: list = None,
    contract_chunks: list = None,
    description: str = None,
    contract_type: Optional[str] = None,
    user_role: Optional[str] = None,
    field: Optional[str] = None,
    concerns: Optional[str] = None,
) -> str:
    """
    ê³„ì•½ì„œ ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ êµ¬ì„± (clause_id ê¸°ë°˜)
    
    Args:
        contract_text: ê³„ì•½ì„œ í…ìŠ¤íŠ¸ (ì°¸ê³ ìš©)
        clauses: ì¶”ì¶œëœ clause ë¦¬ìŠ¤íŠ¸ (í•„ìˆ˜)
        grounding_chunks: ê´€ë ¨ ë²•ë ¹ ì²­í¬ (legal_chunks)
        contract_chunks: ê³„ì•½ì„œ ë‚´ë¶€ ì²­í¬ (contract_chunks, ë ˆê±°ì‹œ í˜¸í™˜)
        description: ì¶”ê°€ ìƒí™© ì„¤ëª…
    
    Returns:
        ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´
    """
    # clausesê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
    if not clauses:
        logger.warning("[í”„ë¡¬í”„íŠ¸ ìƒì„±] clausesê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¹ˆ í”„ë¡¬í”„íŠ¸ ë°˜í™˜.")
        return ""
    
    # clause ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´ ë§Œë“¤ê¸°
    clause_lines = []
    for c in clauses:
        snippet = c.get("content", "")
        if len(snippet) > 400:
            snippet = snippet[:400] + "..."
        clause_id = c.get("id", "")
        title = c.get("title", "")
        clause_lines.append(
            f'- [{clause_id}] {title}\n  "{snippet}"'
        )
    clause_context = "\n".join(clause_lines)
    
    # ë²•ë ¹ ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„
    legal_lines = []
    if grounding_chunks:
        # ê²€ìƒ‰ëœ ëª¨ë“  legal_chunks ì‚¬ìš© (ìµœëŒ€ 15ê°œë¡œ ì œí•œí•˜ì—¬ í”„ë¡¬í”„íŠ¸ ê¸¸ì´ ê´€ë¦¬)
        max_legal_chunks = min(len(grounding_chunks), 15)
        for g in grounding_chunks[:max_legal_chunks]:
            # LegalGroundingChunkëŠ” Pydantic ëª¨ë¸ì´ë¯€ë¡œ getattr ì‚¬ìš©
            source_type = getattr(g, 'source_type', 'law')
            title = getattr(g, 'title', '')
            snippet = getattr(g, 'snippet', getattr(g, 'content', ''))
            # snippet ê¸¸ì´ë¥¼ 300ìë¡œ ëŠ˜ë ¤ì„œ ë” ë§ì€ ì •ë³´ ì œê³µ
            if len(snippet) > 300:
                snippet = snippet[:300] + "..."
            legal_lines.append(
                f'- ({source_type}) {title}: "{snippet}"'
            )
    legal_context = "\n".join(legal_lines) if legal_lines else "(ì°¸ê³  ë²•ë ¹ ì—†ìŒ)"
    
    # ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ì •ë³´ êµ¬ì„±
    user_context = []
    if contract_type:
        contract_type_map = {
            "freelancer": "í”„ë¦¬ëœì„œ",
            "part_time": "ì•Œë°”/íŒŒíŠ¸íƒ€ì„",
            "regular": "ì •ê·œì§",
            "service": "ìš©ì—­",
            "other": "ê¸°íƒ€"
        }
        user_context.append(f"- ê³„ì•½ ì¢…ë¥˜: {contract_type_map.get(contract_type, contract_type)}")
    
    if user_role:
        role_map = {
            "worker": "ì„(í”„ë¦¬ëœì„œ/ê·¼ë¡œì)",
            "employer": "ê°‘(ë°œì£¼ì‚¬/ê³ ìš©ì£¼)"
        }
        user_context.append(f"- ì—­í• : {role_map.get(user_role, user_role)}")
    
    if field:
        field_map = {
            "it_dev": "IT ê°œë°œ",
            "design": "ë””ìì¸",
            "marketing": "ë§ˆì¼€íŒ…",
            "other": "ê¸°íƒ€"
        }
        user_context.append(f"- ë¶„ì•¼: {field_map.get(field, field)}")
    
    if concerns:
        user_context.append(f"- ìš°ì„  í™•ì¸í•˜ê³  ì‹¶ì€ ê³ ë¯¼: {concerns}")
    
    user_context_str = "\n".join(user_context) if user_context else "(ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ)"
    
    system_prompt = """ë‹¹ì‹ ì€ í”„ë¦¬ëœì„œ/ì²­ë…„ ê·¼ë¡œì ê´€ì ì—ì„œ ê³„ì•½ì„œë¥¼ ì ê²€í•˜ëŠ” ê³„ì•½ ë¶„ì„ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

- ì„(í”„ë¦¬ëœì„œ/ê·¼ë¡œì)ì˜ ê¶Œë¦¬ë¥¼ ë³´í˜¸í•˜ëŠ” ê´€ì ì—ì„œ ê³„ì•½ì„œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
- ë…ì†Œì¡°í•­(ì„ì—ê²Œ ê³¼ë„í•˜ê²Œ ë¶ˆë¦¬í•œ ì¡°í•­)ì„ ìš°ì„ ì ìœ¼ë¡œ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
- ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
"""
    
    user_prompt = f"""[ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸]

{user_context_str}

[ê³„ì•½ì„œ ì¡°í•­ ëª©ë¡]

ë‹¤ìŒì€ ì´ ê³„ì•½ì„œë¥¼ ì¡°í•­ë³„ë¡œ ë‚˜ëˆˆ ëª©ë¡ì…ë‹ˆë‹¤.
ê° í•­ëª©ì—ëŠ” "clause_id", "title", "content"ê°€ í¬í•¨ë©ë‹ˆë‹¤.

{clause_context}

[ì°¸ê³  ë²•ë ¹/ê°€ì´ë“œë¼ì¸]

{legal_context}

[ë¶„ì„ í•­ëª©]

ê³„ì•½ì„œë¥¼ ë‹¤ìŒ 9ê°œ í•­ëª©ë³„ë¡œ ë¶„ì„í•˜ì„¸ìš”:

1. í•µì‹¬ ìš”ì•½: ê³„ì•½ ëª©ì Â·ì—…ë¬´ ë‚´ìš©, ê³„ì•½ ê¸°ê°„, ì´ ê¸ˆì•¡Â·ì§€ê¸‰ ë°©ì‹
2. ëˆÂ·ëŒ€ê¸ˆ: ì§€ê¸‰ ë°©ì‹, ì§€ê¸‰ ê¸°í•œ, ì§€ì—° ì‹œ ì´ì/ì§€ì—°ì†í•´ê¸ˆ, ë¹„ìš© í¬í•¨ ì—¬ë¶€
3. ì—…ë¬´ ë²”ìœ„Â·ê·¼ë¡œì¡°ê±´: ì—…ë¬´ ë²”ìœ„ í¬ê´„ì„±, ì¶”ê°€ ì—…ë¬´ ê·œì •, ê·¼ë¬´ ì‹œê°„/íœ´ê²Œ/ì—°ì¥ê·¼ë¡œ ìˆ˜ë‹¹
4. ê¸°ê°„Â·í•´ì§€: ê³„ì•½ ê¸°ê°„, ìë™ ì—°ì¥, ê°‘/ì„ í•´ì§€ê¶Œ ëŒ€ì¹­ì„±, í•´ì§€ ì‹œ ëŒ€ê¸ˆ ì •ì‚°, ìœ„ì•½ê¸ˆ/ì†í•´ë°°ìƒ
5. ì§€ì‹ì¬ì‚°ê¶Œ(IP)Â·ì‚°ì¶œë¬¼: ì‚°ì¶œë¬¼ ì €ì‘ê¶Œ ì†Œìœ ì, í¬íŠ¸í´ë¦¬ì˜¤ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€, 2ì°¨ì  ì €ì‘ë¬¼ ê¸ˆì§€ ë²”ìœ„
6. ë¹„ë°€ìœ ì§€(NDA): ë¹„ë°€ ì •ë³´ ë²”ìœ„, ë¹„ë°€ìœ ì§€ ê¸°ê°„, ìœ„ë°˜ ì‹œ ì±…ì„ ë²”ìœ„
7. ê²½ìŸê¸ˆì§€Â·ê²¸ì—… ì œí•œ: ê³„ì•½ ì¢…ë£Œ í›„ ê¸ˆì§€ ê¸°ê°„/ë²”ìœ„, ì§€ë¦¬ì /ì—…ì¢… ë²”ìœ„, ë°˜ëŒ€ ê¸‰ë¶€ ì—¬ë¶€
8. ì±…ì„Â·ì†í•´ë°°ìƒÂ·ë©´ì±…: ë¬´ì œí•œ ì±…ì„ ì¡°í•­, ê°„ì ‘ì†í•´/íŠ¹ë³„ì†í•´ ë°°ìƒ, ê°‘ì˜ ê³¼ì‹¤ ì±…ì„ ì „ê°€
9. ë¶„ìŸí•´ê²°: ê´€í•  ë²•ì›, ë¶„ìŸ í•´ê²° ì ˆì°¨

[ë…ì†Œì¡°í•­ íƒì§€ ê¸°ì¤€]

ì•„ë˜ì— í•´ë‹¹í•˜ë©´ ë…ì†Œì¡°í•­ìœ¼ë¡œ í‘œì‹œí•˜ì„¸ìš”:

- ëŒ€ê¸ˆ ì§€ê¸‰: "ê²€ìˆ˜ ì™„ë£Œ í›„ ì§€ê¸‰"ë§Œ ìˆê³  ê²€ìˆ˜ ê¸°ì¤€/ê¸°ê°„ì´ ì—†ìŒ
- ìœ„ì•½ê¸ˆÂ·ì§€ì—° ì†í•´ê¸ˆ: ì„ì—ê²Œë§Œ ê³¼ë„í•œ ìœ„ì•½ê¸ˆ, ê°‘ ì§€ê¸‰ ì§€ì—° ì‹œ íŒ¨ë„í‹° ì—†ìŒ
- ë¬´ì œí•œ ì†í•´ë°°ìƒ: "ì–´ë–¤ ê²½ìš°ì—ë„ ëª¨ë“  ì†í•´ë¥¼ ì „ë¶€ ë°°ìƒí•œë‹¤" ê°™ì€ ì¡°í•­
- ì¼ë°©ì  í•´ì§€ê¶Œ: ê°‘ì€ ì–¸ì œë“  í•´ì§€ ê°€ëŠ¥, ì„ì€ í•´ì§€ ì–´ë ¤ì›€
- ê³¼ë„í•œ ê²½ìŸê¸ˆì§€: ì¢…ë£Œ í›„ 1~3ë…„ ì´ìƒ, ì—…ê³„ ì „ë°˜ ê¸ˆì§€, ëŒ€ê°€ ì—†ìŒ
- IP ì™„ì „ ì–‘ë„: ëª¨ë“  ì°½ì‘ë¬¼ ì €ì‘ê¶Œ ì˜êµ¬ ì–‘ë„, í¬íŠ¸í´ë¦¬ì˜¤ ê¸ˆì§€
- ì¼ë°©ì  ë³€ê²½ ê¶Œí•œ: ê°‘ì´ ì¼ë°©ì ìœ¼ë¡œ ê³„ì•½ ìˆ˜ì • ê°€ëŠ¥

[í•´ì•¼ í•  ì¼]

1. ê° clauseë¥¼ ìœ„ 9ê°œ í•­ëª© ê´€ì ì—ì„œ ê²€í† í•˜ì—¬ ë¬¸ì œê°€ ë˜ëŠ” ì¡°í•­ì„ ì°¾ìŠµë‹ˆë‹¤.
2. ë…ì†Œì¡°í•­ í›„ë³´ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‹ë³„í•©ë‹ˆë‹¤.
3. ì´ìŠˆë§ˆë‹¤ ì–´ëŠ clauseì— í•´ë‹¹í•˜ëŠ”ì§€ "clause_id"ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
4. ë°˜ë“œì‹œ ë‚´ê°€ ì œê³µí•œ clause_idë§Œ ì‚¬ìš©í•´ì•¼ í•˜ë©°, ìƒˆë¡œìš´ í…ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ 'ì›ë¬¸'ì¸ ê²ƒì²˜ëŸ¼ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤.
5. í•œ clauseì—ì„œ ì—¬ëŸ¬ ê°œì˜ ë¬¸ì œê°€ ë°œê²¬ë˜ë©´, ê°™ì€ clause_idë¡œ ì—¬ëŸ¬ ì´ìŠˆë¥¼ ìƒì„±í•´ë„ ë©ë‹ˆë‹¤.
6. JSON í˜•ì‹ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.

[ì¶œë ¥ í˜•ì‹]

ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆë¥¼ ì§€í‚¤ì„¸ìš”.

{{
  "risk_score": 0-100,
  "risk_level": "low" | "medium" | "high",
  "summary": "ê³„ì•½ì„œ ì „ì²´ ìœ„í—˜ë„ì— ëŒ€í•œ í•œ ì¤„ ìš”ì•½ (í•œêµ­ì–´)",
  "one_line_summary": "ì„(í”„ë¦¬ëœì„œ/ê·¼ë¡œì)ì—ê²Œ ë¶ˆë¦¬í•œ ì¡°í•­ì´ Nê°œ ìˆìœ¼ë©°, íŠ¹íˆ [ì£¼ìš” ë¬¸ì œ]ê°€ ê³¼ë„í•œ í¸ì…ë‹ˆë‹¤. í˜‘ì˜Â·ìˆ˜ì • ì—†ì´ ê·¸ëŒ€ë¡œ ì„œëª…í•˜ëŠ” ê²ƒì€ ê¶Œì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
  "risk_traffic_light": "ğŸŸ¢ | ğŸŸ¡ | ğŸ”´",
  "top3_action_points": [
    "ì§€ê¸ˆ ë‹¹ì¥ í™•ì¸í•˜ê±°ë‚˜ ë¬¼ì–´ë´ì•¼ í•  í¬ì¸íŠ¸ 1",
    "ì§€ê¸ˆ ë‹¹ì¥ í™•ì¸í•˜ê±°ë‚˜ ë¬¼ì–´ë´ì•¼ í•  í¬ì¸íŠ¸ 2",
    "ì§€ê¸ˆ ë‹¹ì¥ í™•ì¸í•˜ê±°ë‚˜ ë¬¼ì–´ë´ì•¼ í•  í¬ì¸íŠ¸ 3"
  ],
  "risk_summary_table": [
    {{
      "item": "ëŒ€ê¸ˆ ì§€ê¸‰",
      "risk_level": "low | medium | high",
      "problem_point": "ê²€ìˆ˜ í›„ ì§€ê¸‰, ê¸°í•œ ì—†ìŒ",
      "simple_explanation": "ê°‘ì´ ë¬´ê¸°í•œ ê²€ìˆ˜ ì§€ì—° ê°€ëŠ¥",
      "revision_keyword": "ê²€ìˆ˜ í›„ â—‹ì¼ ì´ë‚´ ì§€ê¸‰ ëª…ì‹œ"
    }}
  ],
  "issues": [
    {{
      "issue_id": "ë¬¸ìì—´, ì˜ˆ: issue-1",
      "clause_id": "clause-ë²ˆí˜¸ (ë°˜ë“œì‹œ ìœ„ ëª©ë¡ì— ìˆëŠ” ê²ƒë§Œ ì‚¬ìš©)",
      "category": "wage | working_hours | job_stability | dismissal | payment | ip | nda | non_compete | liability | dispute",
      "severity": "low | medium | high",
      "summary": "ì´ìŠˆë¥¼ í•œ ì¤„ë¡œ ìš”ì•½ (í•œêµ­ì–´)",
      "reason": "ì™œ ë¬¸ì œê°€ ë˜ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª… (í•œêµ­ì–´)",
      "legal_basis": ["ê´€ë ¨ ë²•ì¡°í•­ ë˜ëŠ” ê°€ì´ë“œë¼ì¸"],
      "suggested_revision": "ê°€ëŠ¥í•˜ë‹¤ë©´ ë” ì•ˆì „í•œ ë¬¸êµ¬ ì œì•ˆ (í•œêµ­ì–´)",
      "suggested_questions": ["ì‚¬ì—…ì£¼ì—ê²Œ í™•ì¸í•´ë³¼ ì§ˆë¬¸ ëª©ë¡ (í•œêµ­ì–´)"],
      "toxic_clause_detail": {{
        "clause_location": "ì œâ—‹ì¡°(ì†í•´ë°°ìƒ)",
        "content_summary": "ë‚´ìš© ìš”ì•½",
        "why_risky": "ì™œ ìœ„í—˜í•œì§€",
        "real_world_problems": "í˜„ì‹¤ì—ì„œ ìƒê¸¸ ìˆ˜ ìˆëŠ” ë¬¸ì œ",
        "suggested_revision_light": "ë¼ì´íŠ¸ ë²„ì „ ìˆ˜ì • ì œì•ˆ (ì¼ë°˜ì¸ ë§íˆ¬)",
        "suggested_revision_formal": "í¬ë©€ ë²„ì „ ìˆ˜ì • ì œì•ˆ (ë¡œíŒ/ë³€í˜¸ì‚¬ìš©)"
      }}
    }}
  ],
  "toxic_clauses": [
    {{
      "clause_location": "ì œâ—‹ì¡°(ì†í•´ë°°ìƒ)",
      "content_summary": "ë‚´ìš© ìš”ì•½",
      "why_risky": "ì™œ ìœ„í—˜í•œì§€",
      "real_world_problems": "í˜„ì‹¤ì—ì„œ ìƒê¸¸ ìˆ˜ ìˆëŠ” ë¬¸ì œ",
      "suggested_revision_light": "ë¼ì´íŠ¸ ë²„ì „ ìˆ˜ì • ì œì•ˆ",
      "suggested_revision_formal": "í¬ë©€ ë²„ì „ ìˆ˜ì • ì œì•ˆ"
    }}
  ],
  "negotiation_questions": [
    "ê²€ìˆ˜ ê¸°ê°„ì„ ìµœëŒ€ â—‹ì¼ë¡œ ì œí•œí•  ìˆ˜ ìˆì„ê¹Œìš”?",
    "ì§€ì—° ì‹œ ì§€ì—°ì´ì/ì§€ê¸‰ ê¸°í•œì„ ëª…ì‹œí•´ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”?",
    "ì†í•´ë°°ìƒ í•œë„ë¥¼ 'ì´ ê³„ì•½ê¸ˆì•¡' ìˆ˜ì¤€ìœ¼ë¡œ ì œí•œí•  ìˆ˜ ìˆì„ê¹Œìš”?"
  ],
  "recommendations": [
    "ì „ë°˜ì ì¸ ê°œì„  ê¶Œê³ ì‚¬í•­ (í•œêµ­ì–´)"
  ]
}}

[ì¤‘ìš” ê·œì¹™]

- 'original_text' í•„ë“œë¥¼ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”. ì›ë¬¸ í…ìŠ¤íŠ¸ëŠ” ë‚´ê°€ clause_idë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë”°ë¡œ ì°¾ìŠµë‹ˆë‹¤.
- clause.contentë¥¼ ë‹¤ì‹œ ì¨ì„œ ìš”ì•½í•˜ëŠ” ëŒ€ì‹ , ì™œ ìœ„í—˜í•œì§€ ì„¤ëª…ì— ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤.
- ë…ì†Œì¡°í•­ì€ toxic_clause_detail í•„ë“œì— ìƒì„¸ ì •ë³´ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”.
- JSONë§Œ ì¶œë ¥í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª… í…ìŠ¤íŠ¸ëŠ” ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.
- risk_score: 0-30(low), 31-60(medium), 61-100(high)
- issues ìµœëŒ€ 15ê°œê¹Œì§€, ìš°ì„ ìˆœìœ„ ë†’ì€ ê²ƒë¶€í„° (ë…ì†Œì¡°í•­ ìš°ì„ )
- ë…ì†Œì¡°í•­ì€ toxic_clauses ë°°ì—´ì—ë„ ë³„ë„ë¡œ ì •ë¦¬í•˜ì„¸ìš”.
"""
    
    prompt = f"""{system_prompt}

{user_prompt}"""
    
    # ì‹¤ì œ ì‚¬ìš©ëœ legal_chunks ê°œìˆ˜ ê³„ì‚°
    used_legal_chunks = min(len(grounding_chunks), 15) if grounding_chunks else 0
    logger.info(f"[í”„ë¡¬í”„íŠ¸ ìƒì„±] clause ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ: clauses={len(clauses)}ê°œ, legal_chunks={len(grounding_chunks) if grounding_chunks else 0}ê°œ ê²€ìƒ‰ë¨, {used_legal_chunks}ê°œ í”„ë¡¬í”„íŠ¸ì— ì‚¬ìš©")
    
    return prompt


# ============================================================================
# ìƒí™© ë¶„ì„ í”„ë¡¬í”„íŠ¸
# ============================================================================

SITUATION_ANALYSIS_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ í•œêµ­ ë…¸ë™ë²• ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìƒí™©ì„ ë¶„ì„í•˜ì—¬ ë²•ì  ë¦¬ìŠ¤í¬ì™€ ëŒ€ì‘ ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.

**ë¶„ì„ ì›ì¹™:**
1. ì œê³µëœ ìƒí™© ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë²•ì  ë¦¬ìŠ¤í¬ í‰ê°€
2. ê´€ë ¨ ë²•ë ¹ì„ ê·¼ê±°ë¡œ ì„¤ëª…
3. ì‹¤ë¬´ì ì¸ ëŒ€ì‘ ë°©ì•ˆê³¼ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œì‹œ
4. ìœ ì‚¬ ì¼€ì´ìŠ¤ì™€ ë¹„êµ ë¶„ì„
"""


def build_situation_analysis_prompt(
    situation_text: str,
    category_hint: str = None,
    grounding_chunks: list = None,
    employment_type: str = None,
    work_period: str = None,
    weekly_hours: int = None,
    is_probation: bool = None,
    social_insurance: str = None,
) -> str:
    """
    ìƒí™© ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    
    Args:
        situation_text: ìƒí™© ì„¤ëª…
        category_hint: ì¹´í…Œê³ ë¦¬ íŒíŠ¸
        grounding_chunks: ê´€ë ¨ ë²•ë ¹ ì²­í¬
        employment_type: ê³ ìš© í˜•íƒœ
        work_period: ê·¼ë¬´ ê¸°ê°„
        weekly_hours: ì£¼ë‹¹ ê·¼ë¡œì‹œê°„
        is_probation: ìˆ˜ìŠµ ì—¬ë¶€
        social_insurance: 4ëŒ€ë³´í—˜
    
    Returns:
        ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´
    """
    # ê´€ë ¨ ë²•ë ¹ ì»¨í…ìŠ¤íŠ¸
    legal_context = ""
    if grounding_chunks:
        legal_context = "\n**ì°¸ê³  ë²•ë ¹/ê°€ì´ë“œë¼ì¸:**\n"
        for chunk in grounding_chunks[:8]:
            # LegalGroundingChunkëŠ” Pydantic ëª¨ë¸ì´ë¯€ë¡œ getattr ì‚¬ìš©
            source_type = getattr(chunk, 'source_type', 'law')
            title = getattr(chunk, 'title', '')
            snippet = getattr(chunk, 'snippet', getattr(chunk, 'content', ''))[:300]
            legal_context += f"- [{source_type}] {title}: {snippet}\n"
    
    # ì‚¬ìš©ì ì •ë³´ ìš”ì•½
    user_info = []
    if employment_type:
        user_info.append(f"ê³ ìš© í˜•íƒœ: {employment_type}")
    if work_period:
        user_info.append(f"ê·¼ë¬´ ê¸°ê°„: {work_period}")
    if weekly_hours:
        user_info.append(f"ì£¼ë‹¹ ê·¼ë¡œì‹œê°„: {weekly_hours}ì‹œê°„")
    if is_probation is not None:
        user_info.append(f"ìˆ˜ìŠµ ì—¬ë¶€: {'ìˆ˜ìŠµ ì¤‘' if is_probation else 'ìˆ˜ìŠµ ì•„ë‹˜'}")
    if social_insurance:
        user_info.append(f"4ëŒ€ë³´í—˜: {social_insurance}")
    user_info_text = "\n".join(user_info) if user_info else "ì •ë³´ ì—†ìŒ"
    
    # ì¹´í…Œê³ ë¦¬ ë¼ë²¨ ë§¤í•‘
    category_labels = {
        "harassment": "ì§ì¥ ë‚´ ê´´ë¡­í˜ / ëª¨ìš•",
        "unpaid_wage": "ì„ê¸ˆì²´ë¶ˆ / ìˆ˜ë‹¹ ë¯¸ì§€ê¸‰",
        "unfair_dismissal": "ë¶€ë‹¹í•´ê³  / ê³„ì•½í•´ì§€",
        "overtime": "ê·¼ë¡œì‹œê°„ / ì•¼ê·¼ / íœ´ê²Œì‹œê°„ ë¬¸ì œ",
        "probation": "ìˆ˜ìŠµÂ·ì¸í„´ ê´€ë ¨ ë¬¸ì œ",
        "unknown": "ê¸°íƒ€ / ì˜ ëª¨ë¥´ê² ìŒ",
    }
    category_label = category_labels.get(category_hint, category_hint) if category_hint else ""
    
    prompt = f"""{SITUATION_ANALYSIS_SYSTEM_PROMPT}

**ì‚¬ìš©ì ì •ë³´:**
{user_info_text}

**ìƒí™© ì¹´í…Œê³ ë¦¬ íŒíŠ¸:** {category_label}

**ìƒí™© ì„¤ëª…:**
{situation_text}
{legal_context}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì§„ë‹¨ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ì„¸ìš”:
{{
    "classified_type": "harassment|unpaid_wage|unfair_dismissal|overtime|probation|unknown",
    "risk_score": 0~100 ì‚¬ì´ì˜ ìˆ«ì,
    "summary": "êµ¬ì¡°í™”ëœ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ (ì•„ë˜ ì§€ì‹œì‚¬í•­ ì°¸ê³ )",
    "criteria": [
        {{
            "name": "íŒë‹¨ ê¸°ì¤€ëª…",
            "status": "likely|unclear|unlikely",
            "reason": "íŒë‹¨ ì´ìœ  ë° ì„¤ëª…"
        }}
    ],
    "action_plan": {{
        "steps": [
            {{
                "title": "ì¦ê±° ìˆ˜ì§‘",
                "items": ["êµ¬ì²´ì ì¸ ì¦ê±° ìˆ˜ì§‘ ë°©ë²•"]
            }},
            {{
                "title": "1ì°¨ ëŒ€ì‘",
                "items": ["ì´ˆê¸° ëŒ€ì‘ ë°©ë²•"]
            }},
            {{
                "title": "ìƒë‹´/ì‹ ê³  ë£¨íŠ¸",
                "items": ["ê³ ìš©ë…¸ë™ë¶€ 1350 ìƒë‹´ì„¼í„°", "ì²­ë…„ë…¸ë™ì„¼í„°", "ë…¸ë¬´ì‚¬ ìƒë‹´"]
            }}
        ]
    }},
    "scripts": {{
        "to_company": "íšŒì‚¬ì— ë³´ë‚¼ ì •ì¤‘í•œ ë¬¸ì œ ì œê¸° ë¬¸êµ¬ í…œí”Œë¦¿",
        "to_advisor": "ë…¸ë¬´ì‚¬/ê¸°ê´€ì— ìƒë‹´í•  ë•Œ ì“¸ ì„¤ëª… í…œí”Œë¦¿"
    }}
}}

**âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ì§€ì‹œì‚¬í•­:**

summary í•„ë“œëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ 4ê°œ ì„¹ì…˜ì„ ìˆœì„œëŒ€ë¡œ í¬í•¨í•œ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤:

1. ## ğŸ“Š ìƒí™© ë¶„ì„ì˜ ê²°ê³¼
   - ì œê³µëœ ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ í•µì‹¬ ë¬¸ì œì ê³¼ ìœ„í—˜ë„ë¥¼ ìš”ì•½í•˜ì—¬ 2-3ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…

2. ## âš–ï¸ ë²•ì  ê´€ì ì—ì„œ ë³¸ í˜„ì¬ìƒí™©
   - ê´€ë ¨ ë²•ë ¹ì„ ê·¼ê±°ë¡œ í˜„ì¬ ìƒí™©ì´ ë²•ì ìœ¼ë¡œ ì–´ë–»ê²Œ í‰ê°€ë˜ëŠ”ì§€ ì„¤ëª…
   - êµ¬ì²´ì ì¸ ë²•ì  ê·¼ê±°ì™€ íŒë‹¨ ê¸°ì¤€ì„ í¬í•¨í•˜ì—¬ 3-5ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±
   - ìœ„ì˜ "ì°¸ê³  ë²•ë ¹/ê°€ì´ë“œë¼ì¸" ì„¹ì…˜ì˜ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì‘ì„±

3. ## ğŸ¯ ì§€ê¸ˆ ë‹¹ì¥ í•  ìˆ˜ ìˆëŠ” í–‰ë™
   - ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ í–‰ë™ ë°©ì•ˆì„ 3-5ê°œ í•­ëª©ìœ¼ë¡œ ë‚˜ì—´
   - ê° í•­ëª©ì€ "- " í˜•ì‹ìœ¼ë¡œ ì‘ì„±

4. ## ğŸ’¬ ì´ë ‡ê²Œ ë§í•´ë³´ì„¸ìš”
   - íšŒì‚¬ë‚˜ ìƒë‹´ ê¸°ê´€ì— ì‹¤ì œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë¬¸êµ¬ í…œí”Œë¦¿ì„ ì œê³µ
   - ì‹¤ì œ ëŒ€í™”ì—ì„œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±

ê¸°íƒ€ ì‚¬í•­:
- ëª¨ë“  ì‘ë‹µì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
- summaryëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ê° ì„¹ì…˜ì„ ëª…í™•í•˜ê²Œ êµ¬ë¶„í•˜ì„¸ìš”.
- criteriaëŠ” 3~5ê°œ ì •ë„ë¡œ êµ¬ì„±í•˜ì„¸ìš”.
- action_planì˜ stepsëŠ” 3ë‹¨ê³„ ì •ë„ë¡œ êµ¬ì„±í•˜ì„¸ìš”.
- scriptsëŠ” ì‹¤ì œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë¬¸êµ¬ë¡œ ì‘ì„±í•˜ì„¸ìš”.

JSON í˜•ì‹ë§Œ ë°˜í™˜í•˜ì„¸ìš”. summary í•„ë“œì—ëŠ” ìœ„ì˜ 4ê°œ ì„¹ì…˜ì„ ëª¨ë‘ í¬í•¨í•œ ì™„ì „í•œ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
"""
    
    return prompt

