# 견적서 열람 MVP 구현 가이드

## 📋 요구사항

1. **구성**: 무제한 열람(구독제) + 무료 열람(신규 회원가입 시 3회)
2. **구독 가격**: 월 1만원
3. **무료 제공**: 신규 회원가입 시 구독 없이도 최초 3회 무료 열람 제공 (구독과 별개)
4. **건별 결제**: 제거됨 (구독 가입으로 유도)

## 🗄️ 데이터베이스 구조

### 테이블 생성

```sql
-- estimate_views: 견적서 열람 기록
-- client.free_estimate_views_remaining: 무료 열람 횟수 (기본 3회)
```

마이그레이션 파일: `database_estimate_view_access_migration.sql`

## 🔧 구현 내용

### 1. API 서비스 (`src/apis/estimate-view.service.ts`)

- `checkEstimateViewAccess()`: 열람 권한 확인
- `createEstimateView()`: 무료/구독 열람 기록 생성
- `getEstimateViewHistory()`: 열람 기록 조회

### 2. 구독 가입 유도

- 구독 없을 시 "월 1만원 구독으로 무제한 열람하기" 버튼 표시
- 구독 가입 페이지로 리다이렉트

### 3. UI 구현 (`src/app/(home)/my/company/estimates/CompanyEstimatesClient.tsx`)

- 견적서 상세 페이지에 열람 권한 체크
- 열람 불가 시 결제/무료 열람 버튼 표시
- 열람 가능 시 상세 내용 표시

## 📝 사용 흐름

### 무료 열람
1. 사용자가 견적서 상세 페이지 접근
2. `checkEstimateViewAccess()` 호출
3. 무료 열람 횟수 확인 (기본 3회)
4. 무료 열람 가능 시 "무료로 열람하기" 버튼 표시
5. 버튼 클릭 시 `createEstimateView(estimateId, 'free')` 호출
6. 무료 열람 횟수 차감 및 열람 기록 생성
7. 상세 내용 표시

### 구독 열람
1. 사용자가 활성 구독 보유 확인
2. "구독으로 열람하기" 버튼 표시
3. 버튼 클릭 시 `createEstimateView(estimateId, 'subscription')` 호출
4. 열람 기록 생성 (구독 ID 포함)
5. 상세 내용 표시

### 구독 가입 필요
1. 무료 열람 횟수 없음 + 구독 없음
2. "월 1만원 구독으로 무제한 열람하기" 버튼 표시
3. 버튼 클릭 시 구독 가입 페이지로 이동 (`/my/subscription/register-v2`)
4. 구독 가입 완료 후 다시 견적서 상세 페이지 접근
5. "구독으로 열람하기" 버튼 표시
6. 열람 기록 생성 및 상세 내용 표시

## 🚀 다음 단계

1. **무료 열람 횟수 마이그레이션**
   - 기존 사용자에게 기본값(3회) 적용

2. **건별 결제 API 정리** (선택)
   - 사용되지 않는 API 주석 처리 또는 삭제

3. **열람 기록 관리**
   - 열람 기록 조회 페이지 ✅
   - 열람 통계 (월별, 프로젝트별) - 향후 구현

## 📊 데이터 흐름

```
견적서 상세 페이지 접근
  ↓
checkEstimateViewAccess()
  ↓
이미 열람함? → YES → 상세 내용 표시 (연락처 포함)
  ↓ NO
무료 열람 가능? → YES → 무료 열람 버튼
  ↓ NO
구독 중? → YES → 구독 열람 버튼
  ↓ NO
구독 가입 필요 → 구독 가입 버튼 (구독 가입 페이지로 이동)
```

## 🔒 보안 고려사항

- RLS 정책으로 열람 기록 접근 제어
- 중복 열람 방지 (UNIQUE 제약조건)
- 구독 상태 검증 (활성 구독만 열람 가능)

