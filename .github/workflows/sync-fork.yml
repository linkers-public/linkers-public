name: Sync Fork with Upstream

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
  # ë§¤ì¼ ìì •ì— ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€)
  schedule:
    - cron: '0 0 * * *'
  # main ë¸Œëœì¹˜ì— pushë  ë•Œë§ˆë‹¤ ì‹¤í–‰
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add upstream remote
        run: |
          # ê¸°ì¡´ upstreamì´ ìˆìœ¼ë©´ ì œê±°
          git remote remove upstream 2>/dev/null || true
          # upstream ì¶”ê°€ (ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í‚µ)
          git remote add upstream https://github.com/suhyeon10/linkers.git || {
            echo "âš ï¸ Upstream ì €ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. private ì €ì¥ì†Œì´ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            echo "ì›Œí¬í”Œë¡œìš°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          }

      - name: Fetch upstream changes
        run: |
          # upstream ì €ì¥ì†Œ ì ‘ê·¼ ì‹œë„
          if ! git fetch upstream 2>&1; then
            echo "âš ï¸ Upstream ì €ì¥ì†Œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "ê°€ëŠ¥í•œ ì›ì¸:"
            echo "  - ì €ì¥ì†Œê°€ privateì´ê³  ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŒ"
            echo "  - ì €ì¥ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ"
            echo "  - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"
            echo "ì›Œí¬í”Œë¡œìš°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi

      - name: Check if main branch exists
        id: check-main
        run: |
          if git show-ref --verify --quiet refs/heads/main; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream/main into origin/main
        run: |
          git checkout main
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # upstream/mainì˜ ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜´
          echo "ğŸ”„ Upstream/mainê³¼ origin/main ë¹„êµ ì¤‘..."
          git fetch origin main
          
          # upstreamê³¼ originì˜ ì°¨ì´ í™•ì¸
          LOCAL=$(git rev-parse main)
          REMOTE=$(git rev-parse origin/main)
          UPSTREAM=$(git rev-parse upstream/main 2>/dev/null || echo "")
          
          echo "Local main: $LOCAL"
          echo "Origin main: $REMOTE"
          echo "Upstream main: $UPSTREAM"
          
          if [ -z "$UPSTREAM" ]; then
            echo "âš ï¸ Upstream/mainì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi
          
          # upstream/mainì´ origin/mainë³´ë‹¤ ì•ì„œ ìˆëŠ”ì§€ í™•ì¸
          if git merge-base --is-ancestor origin/main upstream/main 2>/dev/null; then
            echo "âœ… Upstreamì— ìƒˆë¡œìš´ ì»¤ë°‹ì´ ìˆìŠµë‹ˆë‹¤. ë³‘í•©ì„ ì§„í–‰í•©ë‹ˆë‹¤."
            
            # upstream/mainì˜ ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜´
            git merge upstream/main --no-edit || {
              echo "âš ï¸ Merge conflict detected. Attempting to resolve..."
              # ì¶©ëŒ ë°œìƒ ì‹œ í˜„ì¬ ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ ìš°ì„ 
              git checkout --ours .
              git add .
              git commit -m "chore: sync with upstream (resolve conflicts)" || true
            }
            
            # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ í‘¸ì‹œ
            if [ "$(git rev-parse HEAD)" != "$REMOTE" ]; then
              echo "ğŸ“¤ ë³€ê²½ì‚¬í•­ì„ origin/mainì— í‘¸ì‹œí•©ë‹ˆë‹¤."
              git push origin main
            else
              echo "â„¹ï¸ ë™ê¸°í™”í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            echo "â„¹ï¸ Upstreamì— ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

